# 本地开发用：API/Web 热更新（gradle bootRun + npm run dev）
# 不会自动加载，需显式指定：docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# 服务器部署请只用 docker-compose.yml，不要加本文件，否则 api 会以开发模式运行并可能退出
services:
  api:
    build:
      context: ../apps/api
      dockerfile: Dockerfile
      target: build
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: blog
      DB_USER: blog
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JAVA_TOOL_OPTIONS: "-Dspring.devtools.restart.enabled=true"
    volumes:
      - ../apps/api:/app
      - gradle_cache:/home/gradle/.gradle
    entrypoint: ["gradle", "bootRun", "--no-daemon"]

  web:
    build:
      context: ../apps/web
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE: /api
      INTERNAL_API_URL: http://api:8080
      WATCHPACK_POLLING: "true"
    volumes:
      - ../apps/web:/app
      - web_node_modules:/app/node_modules
    command: ["sh", "-lc", "npm install && npm run dev -- -p 3000 -H 0.0.0.0"]

volumes:
  gradle_cache:
  web_node_modules:
