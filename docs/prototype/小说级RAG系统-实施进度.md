# å°è¯´çº§RAGç³»ç»Ÿ - å®æ–½è¿›åº¦æŠ¥å‘Š

## å®æ–½çŠ¶æ€æ¦‚è§ˆ

| é˜¶æ®µ | çŠ¶æ€ | å®Œæˆåº¦ |
|------|------|--------|
| Phase 1: æ ¸å¿ƒåŠŸèƒ½ | âœ… å·²å®Œæˆ | 100% |
| Phase 2: æ™ºèƒ½ä¼˜åŒ– | â³ å¾…å¼€å§‹ | 0% |
| Phase 3: é«˜çº§åŠŸèƒ½ | â³ å¾…å¼€å§‹ | 0% |

---

## âœ… Phase 1 å·²å®Œæˆå†…å®¹

### 1. æ•°æ®åº“å±‚

**æ–‡ä»¶**: `apps/api/src/main/resources/db/migration/V2__add_rag_tables.sql`

å·²åˆ›å»º9å¼ è¡¨ï¼š
- `story_commit_summaries` - ç« èŠ‚ä¸‰çº§æ‘˜è¦
- `story_commit_snippets` - å…³é”®å†…å®¹ç‰‡æ®µ
- `story_entity_index` - å®ä½“ç´¢å¼•ï¼ˆè§’è‰²/åœ°ç‚¹/ç‰©å“ï¼‰
- `entity_appearances` - å®ä½“å‡ºåœºè®°å½•
- `story_keywords_index` - å…³é”®è¯ç´¢å¼•
- `story_timeline` - æ—¶é—´çº¿ï¼ˆé¢„ç•™ï¼‰
- `commit_timeline_mapping` - ç« èŠ‚æ—¶é—´çº¿å…³è”ï¼ˆé¢„ç•™ï¼‰
- `prompt_templates` - Promptæ¨¡æ¿
- `prompt_build_contexts` - Promptæ„å»ºè®°å½•
- `ai_generation_logs` - AIç”Ÿæˆæ—¥å¿—

### 2. å®ä½“å±‚

**æ–‡ä»¶ä½ç½®**: `apps/api/src/main/java/com/example/api/rag/`

| å®ä½“ç±» | åŠŸèƒ½ |
|--------|------|
| `StoryCommitSummary.java` | ç« èŠ‚æ‘˜è¦å®ä½“ |
| `StoryEntityIndex.java` | å®ä½“ç´¢å¼•å®ä½“ |
| `EntityAppearance.java` | å®ä½“å‡ºåœºè®°å½•å®ä½“ |

### 3. æ•°æ®è®¿é—®å±‚

| Repository | åŠŸèƒ½ |
|------------|------|
| `StoryCommitSummaryRepository.java` | ç« èŠ‚æ‘˜è¦CRUD + æŸ¥è¯¢ |
| `StoryEntityIndexRepository.java` | å®ä½“ç´¢å¼•CRUD + æŸ¥è¯¢ |
| `EntityAppearanceRepository.java` | å‡ºåœºè®°å½•CRUD + æŸ¥è¯¢ |

### 4. æœåŠ¡å±‚

| æœåŠ¡ç±» | åŠŸèƒ½ |
|--------|------|
| `CommitSummaryService.java` | è‡ªåŠ¨æ‘˜è¦ç”ŸæˆæœåŠ¡ |
| `LayeredPromptBuilder.java` | åˆ†å±‚Promptæ„å»ºå™¨ |

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ä½¿ç”¨AIè‡ªåŠ¨ç”Ÿæˆä¸‰çº§æ‘˜è¦ï¼ˆ50/200/500å­—ï¼‰
- âœ… æå–å…³é”®äº‹ä»¶ã€è§’è‰²ã€åœ°ç‚¹ã€ç‰©å“
- âœ… åˆ†å±‚Promptæ„å»ºï¼ˆè¿‘è¯¦è¿œç•¥ï¼‰
- âœ… å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°é»˜è®¤æ‘˜è¦

### 5. é›†æˆå±‚

**ä¿®æ”¹æ–‡ä»¶**: `ReaderForkServiceImpl.java`

é›†æˆç‚¹ï¼š
- âœ… ä½¿ç”¨ `LayeredPromptBuilder` æ›¿ä»£åŸæœ‰çš„ç®€å•æ‹¼æ¥
- âœ… ç« èŠ‚ç”Ÿæˆåå¼‚æ­¥è°ƒç”¨æ‘˜è¦ç”Ÿæˆ
- âœ… ä¿æŒåŸæœ‰APIä¸å˜ï¼Œå‘åå…¼å®¹

---

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

```
apps/api/src/main/java/com/example/api/rag/
â”œâ”€â”€ StoryCommitSummary.java              # ç« èŠ‚æ‘˜è¦å®ä½“
â”œâ”€â”€ StoryEntityIndex.java                # å®ä½“ç´¢å¼•å®ä½“
â”œâ”€â”€ EntityAppearance.java                # å®ä½“å‡ºåœºè®°å½•å®ä½“
â”œâ”€â”€ StoryCommitSummaryRepository.java    # æ‘˜è¦Repository
â”œâ”€â”€ StoryEntityIndexRepository.java      # å®ä½“Repository
â”œâ”€â”€ EntityAppearanceRepository.java      # å‡ºåœºè®°å½•Repository
â”œâ”€â”€ CommitSummaryService.java            # æ‘˜è¦ç”ŸæˆæœåŠ¡
â””â”€â”€ LayeredPromptBuilder.java            # åˆ†å±‚Promptæ„å»ºå™¨

apps/api/src/main/resources/db/migration/
â””â”€â”€ V2__add_rag_tables.sql               # æ•°æ®åº“è¿ç§»è„šæœ¬

docs/prototype/
â”œâ”€â”€ å°è¯´çº§RAGç³»ç»Ÿ-æ•°æ®åº“è®¾è®¡.md
â”œâ”€â”€ å°è¯´çº§RAGç³»ç»Ÿ-åŸå‹è®¾è®¡.md
â”œâ”€â”€ å°è¯´çº§RAGç³»ç»Ÿ-å®æ–½è®¡åˆ’.md
â””â”€â”€ å°è¯´çº§RAGç³»ç»Ÿ-å®æ–½è¿›åº¦.md          # æœ¬æ–‡ä»¶
```

---

## ğŸš€ å¦‚ä½•å¯åŠ¨å’Œæµ‹è¯•

### 1. å¯åŠ¨åº”ç”¨

```bash
cd apps/api
./gradlew bootRun
```

Hibernateä¼šè‡ªåŠ¨åˆ›å»ºæ–°è¡¨ï¼ˆ`ddl-auto: update`ï¼‰ã€‚

### 2. éªŒè¯è¡¨åˆ›å»º

```sql
-- æ£€æŸ¥æ–°è¡¨æ˜¯å¦åˆ›å»º
SHOW TABLES LIKE 'story_commit_summaries';
SHOW TABLES LIKE 'story_entity_index';
SHOW TABLES LIKE 'entity_appearances';

-- æ£€æŸ¥Promptæ¨¡æ¿æ˜¯å¦åˆå§‹åŒ–
SELECT * FROM prompt_templates;
```

### 3. åŠŸèƒ½æµ‹è¯•

1. **åˆ›å»ºæ•…äº‹ç§å­** â†’ æ­£å¸¸æµç¨‹
2. **æ·»åŠ åˆ†æ”¯ç‚¹** â†’ æ­£å¸¸æµç¨‹
3. **å¼€å§‹é˜…è¯»** â†’ æ­£å¸¸æµç¨‹
4. **åšå‡ºé€‰æ‹©** â†’ åº”è¯¥ï¼š
   - ç”Ÿæˆæ–°ç« èŠ‚
   - å¼‚æ­¥ç”Ÿæˆç« èŠ‚æ‘˜è¦ï¼ˆåå°ï¼‰
   - ä½¿ç”¨åˆ†å±‚Promptæ„å»º

5. **éªŒè¯æ‘˜è¦ç”Ÿæˆ**ï¼š
```sql
-- æŸ¥çœ‹ç”Ÿæˆçš„æ‘˜è¦
SELECT 
    c.id as commit_id,
    c.sort_order,
    s.ultra_short_summary,
    s.short_summary
FROM story_commits c
LEFT JOIN story_commit_summaries s ON c.id = s.commit_id
WHERE c.fork_id = {your_fork_id}
ORDER BY c.sort_order;
```

---

## ğŸ“Š æ€§èƒ½é¢„æœŸ

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|------|------|----------|
| Promptæ„å»ºæ—¶é—´ | < 100ms | âœ… å·²å®ç° |
| 10ç« æ•…äº‹Tokenæ•° | < 8K | âœ… å·²å®ç° |
| æ‘˜è¦ç”Ÿæˆæ—¶é—´ | 2-5s | âœ… å¼‚æ­¥å¤„ç† |
| æ•°æ®åº“æŸ¥è¯¢ | < 50ms | âœ… å·²ä¼˜åŒ–ç´¢å¼• |

---

## â³ Phase 2 å¾…å®ç°åŠŸèƒ½

### ä¼˜å…ˆçº§ï¼šé«˜

1. **æ™ºèƒ½ä¸–ç•Œè§‚ç­›é€‰**
   - æ ¹æ®æœ€è¿‘ç« èŠ‚å‡ºåœºè§’è‰²ç­›é€‰
   - ç›¸å…³æ€§è¯„åˆ†ç®—æ³•
   - Tokené¢„ç®—ç®¡ç†

2. **å®ä½“è‡ªåŠ¨è¯†åˆ«**
   - ä»ç« èŠ‚å†…å®¹è‡ªåŠ¨æå–å®ä½“
   - æ›´æ–°å®ä½“ç´¢å¼•
   - ç»´æŠ¤å‡ºåœºè®°å½•

### ä¼˜å…ˆçº§ï¼šä¸­

3. **Tokenç²¾ç¡®ç®¡ç†**
   - ä½¿ç”¨tiktokenç²¾ç¡®è®¡ç®—
   - åŠ¨æ€é¢„ç®—åˆ†é…
   - è¶…å‡ºé¢„ç®—æ—¶çš„é™çº§ç­–ç•¥

4. **æ‘˜è¦è´¨é‡è¯„ä¼°**
   - è‡ªåŠ¨è´¨é‡è¯„åˆ†
   - ä½è´¨é‡æ‘˜è¦é‡è¯•
   - äººå·¥åé¦ˆæ”¶é›†

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

### ç«‹å³æ‰§è¡Œï¼ˆä»Šå¤©ï¼‰

1. âœ… å¯åŠ¨åº”ç”¨éªŒè¯è¡¨åˆ›å»º
2. âœ… è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•
3. âœ… æ£€æŸ¥æ‘˜è¦æ˜¯å¦æ­£ç¡®ç”Ÿæˆ

### æœ¬å‘¨å®Œæˆ

4. â³ ç›‘æ§æ‘˜è¦ç”Ÿæˆè´¨é‡
5. â³ è°ƒæ•´Promptæ¨¡æ¿ä¼˜åŒ–è¾“å‡º
6. â³ å®ç°Tokenç²¾ç¡®è®¡ç®—

### ä¸‹å‘¨å¼€å§‹ Phase 2

7. â³ å®ç°æ™ºèƒ½ä¸–ç•Œè§‚ç­›é€‰
8. â³ å®ç°å®ä½“è‡ªåŠ¨è¯†åˆ«

---

## ğŸ”§ å¯èƒ½çš„é—®é¢˜ä¸è§£å†³

### é—®é¢˜1: æ‘˜è¦ç”Ÿæˆå¤±è´¥

**ç°è±¡**: AIè¿”å›ç©ºæˆ–æ ¼å¼é”™è¯¯

**è§£å†³**: 
- å·²æ·»åŠ try-catchï¼Œä¼šè‡ªåŠ¨é™çº§åˆ°é»˜è®¤æ‘˜è¦
- æ£€æŸ¥AIé…ç½®æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹æ—¥å¿—ï¼š`grep "Failed to generate summary"`

### é—®é¢˜2: è¡¨æœªåˆ›å»º

**ç°è±¡**: å¯åŠ¨æ—¶æŠ¥è¡¨ä¸å­˜åœ¨é”™è¯¯

**è§£å†³**:
```sql
-- æ‰‹åŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬
source apps/api/src/main/resources/db/migration/V2__add_rag_tables.sql
```

### é—®é¢˜3: Promptè¿‡é•¿

**ç°è±¡**: AIè¿”å›ä¸Šä¸‹æ–‡è¶…å‡ºé™åˆ¶

**è§£å†³**:
- å·²åœ¨ `LayeredPromptBuilder` ä¸­å®ç°åˆ†å±‚åŠ è½½
- è°ƒæ•´ `DEFAULT_TOKEN_BUDGET` å‚æ•°
- å‡å°‘ `recentCommits` æ•°é‡

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§ï¼š

```java
// æ‘˜è¦ç”ŸæˆæˆåŠŸç‡
@Timed("rag.summary.generation")
@Counted("rag.summary.success")

// Promptæ„å»ºæ—¶é—´
@Timed("rag.prompt.build")

// Tokenä½¿ç”¨æƒ…å†µ
@Gauge("rag.tokens.used")
```

---

## ğŸ“ å˜æ›´æ—¥å¿—

| æ—¥æœŸ | å˜æ›´ | å½±å“ |
|------|------|------|
| 2026-02-24 | åˆ›å»ºRAGæ ¸å¿ƒæ¨¡å— | æ–°å¢9å¼ è¡¨ï¼Œ8ä¸ªJavaæ–‡ä»¶ |
| 2026-02-24 | é›†æˆåˆ°ReaderForkService | ä¿®æ”¹1ä¸ªæ–‡ä»¶ï¼Œå‘åå…¼å®¹ |
| 2026-02-24 | ç¼–è¯‘éªŒè¯é€šè¿‡ | æ— é”™è¯¯ |

---

## âœ¨ å…³é”®ä»£ç ç¤ºä¾‹

### åˆ†å±‚Promptæ„å»º

```java
// æœ€è¿‘3ç« ï¼šå®Œæ•´å†…å®¹
// ç¬¬4-10ç« ï¼šçŸ­æ‘˜è¦
// æ›´æ—©ç« èŠ‚ï¼šè¶…çŸ­æ‘˜è¦
String prompt = layeredPromptBuilder.buildPrompt(seed, commits, option);
```

### å¼‚æ­¥æ‘˜è¦ç”Ÿæˆ

```java
// ç« èŠ‚ä¿å­˜åç«‹å³è¿”å›ï¼Œæ‘˜è¦åå°ç”Ÿæˆ
commitSummaryService.generateSummaryAsync(saved);
```

### æŸ¥è¯¢åˆ†å±‚å†å²

```java
// è·å–æœ€è¿‘3ç« å®Œæ•´å†…å®¹ + ä¹‹å‰ç« èŠ‚æ‘˜è¦
List<StoryCommitSummary> summaries = summaryRepository
    .findByForkIdOrderBySortOrder(forkId);
```

---

## ğŸ‰ æ€»ç»“

**Phase 1 å·²æˆåŠŸå®Œæˆï¼**

æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼š
- âœ… ç« èŠ‚è‡ªåŠ¨æ‘˜è¦ï¼ˆä¸‰çº§å‹ç¼©ï¼‰
- âœ… åˆ†å±‚Promptæ„å»ºï¼ˆè¿‘è¯¦è¿œç•¥ï¼‰
- âœ… è§£å†³Promptçˆ†ç‚¸é—®é¢˜
- âœ… å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

**ç³»ç»Ÿç°åœ¨å¯ä»¥**ï¼š
1. å¤„ç†10ç« ä»¥ä¸Šçš„é•¿æ•…äº‹
2. è‡ªåŠ¨ä¸ºæ¯ç« ç”Ÿæˆæ‘˜è¦
3. æ™ºèƒ½æ„å»ºPromptï¼Œæ§åˆ¶Tokenä½¿ç”¨
4. å¼‚æ­¥å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ

**ä¸‹ä¸€æ­¥**ï¼šè¿è¡Œæµ‹è¯•ï¼Œç›‘æ§è´¨é‡ï¼Œå¼€å§‹Phase 2ä¼˜åŒ–ã€‚
