# 原型：用户中心/设置 + Markdown 预览（已实现）

基于本期实现：**用户中心/设置**（个人资料、修改密码）、**写文章 Markdown 实时预览**。以下为对应原型说明，可与 CHANGELOG、API 文档对照。

---

## 一、用户中心/设置

### 1.1 目标

- 登录用户可查看与修改个人资料（当前为邮箱）、修改密码。
- 前端不再仅依赖 localStorage 的 user，可调用后端获取当前用户信息。

### 1.2 已确认选项

- **资料范围**：用户名只读展示；邮箱可编辑并保存。
- **密码**：修改密码需校验当前密码，新密码 6～72 字符，前端做「确认新密码」一致性校验。
- **入口**：导航栏用户下拉菜单与移动端菜单中增加「账号设置」入口。

### 1.3 后端

| 类型 | 说明 |
|------|------|
| **数据** | 沿用现有 **users** 表；无新增表。User 实体增加 `setEmail` 以支持更新邮箱。 |
| **安全** | 仅 `/api/auth/register`、`/api/auth/login` 匿名可访问；其余 `/api/auth/**`（含 /me、/me/password）需 JWT 认证。 |
| **API** | ① **GET /api/auth/me**：返回当前用户 `id`、`username`、`email`；未认证 401。② **PUT /api/auth/me**：请求体 `{ "email": "..." }`，更新邮箱；若邮箱已被占用返回 409 `email_taken`。③ **PUT /api/auth/me/password**：请求体 `{ "currentPassword", "newPassword" }`，当前密码错误返回 401 `bad_credentials`；成功 204 无 body。 |

### 1.4 前端

| 页面/组件 | 说明 |
|-----------|------|
| **账号设置页 /me/settings** | 需登录，未登录跳转 `/login?next=/me/settings`。首屏调用 GET /api/auth/me 拉取并展示资料。 |
| **个人资料区块** | 用户名：只读输入框（灰色背景）。邮箱：可编辑输入框，带「保存资料」按钮；提交调用 PUT /api/auth/me；成功/失败有文案提示。 |
| **修改密码区块** | 当前密码、新密码、确认新密码三个输入框；提交时前端校验两次新密码一致，再调用 PUT /api/auth/me/password；成功后可清空表单并显示成功提示；失败显示错误信息（如 bad_credentials）。 |
| **导航** | Layout 用户下拉与移动端菜单中增加「账号设置」链接，指向 `/me/settings`。页内提供「返回我的文章」链接。 |

### 1.5 本期不做的（避免范围蔓延）

- 不修改用户名、不单独「个人资料」与「账号安全」分页。
- 无头像上传、无后端登出接口（登出仍为前端清 localStorage）。
- 无 JWT 刷新、无邮箱验证流程。

---

## 二、Markdown 预览

### 2.1 目标

- 写文章/编辑文章时，支持**双栏**：左侧 Markdown 编辑、右侧**实时预览**，所见即所得。

### 2.2 已确认选项

- **布局**：大屏（lg）左右双栏；小屏上下排列（先编辑区，后预览区）。
- **预览内容**：仅渲染正文 Markdown，不包含标题、标签等；与文章详情页展示风格一致（prose 排版）。
- **空状态**：无内容时预览区显示占位文案「输入内容后将在此显示预览」。

### 2.3 后端

- 无变更；仍使用现有文章创建/更新接口与 `contentMarkdown` 字段。

### 2.4 前端

| 页面/组件 | 说明 |
|-----------|------|
| **写文章 /write** | 页面容器由单栏 `max-w-3xl` 改为 `max-w-5xl`，以容纳双栏。 |
| **内容区域** | 标签「内容（Markdown）」下为 `grid grid-cols-1 lg:grid-cols-2 gap-4`：**左栏**：`textarea`，等宽字体、可纵向拉伸，placeholder「在此输入 Markdown…」。**右栏**：预览区，圆角边框、浅底，标题「实时预览」；正文区域使用 `react-markdown` + Tailwind `prose` 渲染 `contentMarkdown`；无内容时显示占位文案。 |
| **说明文案** | 页面顶部说明改为：「内容支持 Markdown，右侧为实时预览。标签可自由输入，回车添加。」 |

### 2.5 创意与增强（可选）

| 项 | 说明 |
|----|------|
| **编辑/预览切换** | 小屏可提供 Tab「编辑」「预览」切换，节省纵向空间。 |
| **同步滚动** | 左右栏按比例同步滚动（需额外计算，可选）。 |
| **代码高亮** | 若 prose 未覆盖代码块样式，可引入 `remark-gfm`、代码高亮插件等。 |

---

## 三、实现顺序（本期已完成）

1. **用户中心**：后端 GET/PUT /api/auth/me、PUT /api/auth/me/password + Security 调整 → 前端 services/user、/me/settings 页 + Layout 入口。
2. **Markdown 预览**：前端安装 react-markdown，写文章页内容区改为双栏 + 实时预览。

---

## 四、与现有原型的衔接

- 本文档对应「用户中心/设置」「Markdown 预览」两处待办，与 [标签评论搜索.md](./标签评论搜索.md) 无冲突，可并存。
- API 变更已写入 [API.md](../API.md)；代码变更见 [CHANGELOG_用户中心与Markdown预览.md](../CHANGELOG_用户中心与Markdown预览.md)。

---

## 五、补充：标签入库与我的文章按标签筛选（待确认后实现）

### 5.1 问题与目标

- **标签入库**：写文章/编辑文章时前台填写的标签需**可靠写入数据库**（post_tags），并在文章列表、详情、我的文章等接口中**正确返回** tags；若存在未落库或未返回的情况，需排查并修复。
- **我的文章按标签分类**：在「我的文章」页支持**按标签筛选**，仅展示带有选中标签的文章，便于作者按分类查看。

### 5.2 后端

| 类型 | 说明 |
|------|------|
| **标签落库** | 确认 POST /api/posts、PUT /api/posts/{id} 请求体中的 `tags` 已写入 post_tags；GET /api/posts、GET /api/posts/me、GET /api/posts/{id}、GET /api/posts/slug/{slug} 响应中均包含 tags 字段。若任一环节缺失则补全。 |
| **我的文章按 tag 筛选** | **GET /api/posts/me** 增加可选 Query 参数 **tag**：当 `tag` 非空时，仅返回当前用户创作的、且 tags 中包含该 tag 的文章（含草稿与已发布）；分页、排序与现有一致。 |

### 5.3 前端

| 页面/组件 | 说明 |
|-----------|------|
| **写文章 /write、编辑** | 提交创建/更新时确保将当前标签列表以 `tags` 数组随请求体提交；若存在未传或传空的问题则修复，保证前台展示的标签与入库一致。 |
| **我的文章 /me/posts** | ① 列表数据来源：调用 GET /api/posts/me，支持传入可选参数 `tag`（来自当前筛选条件）。② **按标签筛选**：从当前用户文章列表中聚合出出现过的所有标签（或调用已有 GET /api/tags 仅限本用户文章维度，若后端无单独接口则用列表结果前端聚合）；在列表上方提供标签筛选入口（如标签芯片 / 下拉），点击某标签时请求带 `tag=该标签`，仅展示带该标签的文章；提供「全部」选项清除 tag 筛选，展示全部我的文章。③ 列表项可展示该文章的标签（芯片或文字），与详情/编辑页一致。 |

### 5.4 实现顺序建议

1. 后端：确认并必要时修复 tags 的写入与返回；为 GET /api/posts/me 增加 `tag` 参数及按 tag 过滤逻辑。
2. 前端：确认写/编文章提交时 tags 正确传参；我的文章页增加标签聚合展示、按标签筛选交互及带 `tag` 的列表请求。

---

*以上为补充原型，确认后按此实现。*
